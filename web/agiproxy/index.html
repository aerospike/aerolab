{{define "index"}}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />      
        <link rel="stylesheet" href="dist/bs/bootstrap.min.css" />
        <link rel="stylesheet" href="dist/fa/fontawesome.min.css" />
        <link href="dist/datatables/jquery-ui.min.css" rel="stylesheet">
        <link href="dist/datatables/datatables.min.css" rel="stylesheet">
        <title>{{.Title}}</title>
        <style>
            .local-btn-pushable {
              margin-bottom: 10px;
              position: relative;
              border: none;
              background: transparent;
              padding: 0;
              cursor: pointer;
              outline-offset: 4px;
              transition: filter 250ms;
              width: 12em;
            }
            .local-btn-shadow {
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              border-radius: 12px;
              background: hsl(0deg 0% 0% / 0.25);
              will-change: transform;
              transform: translateY(2px);
              transition:
                transform
                600ms
                cubic-bezier(.3, .7, .4, 1);
            }
            .local-btn-edge {
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              border-radius: 12px;
              background: linear-gradient(
                to left,
                hsl(233, 100%, 16%) 0%,
                hsl(231, 100%, 32%) 8%,
                hsl(249, 100%, 32%) 92%,
                hsl(226, 100%, 16%) 100%
              );
            }
            .local-btn-front {
              display: block;
              position: relative;
              padding: 12px 42px;
              border-radius: 12px;
              font-size: 1.25rem;
              color: white;
              background: hsl(240, 100%, 47%);
              will-change: transform;
              transform: translateY(-4px);
              transition:
                transform
                600ms
                cubic-bezier(.3, .7, .4, 1);
            }
            .local-btn-pushable:hover {
              filter: brightness(110%);
            }
            .local-btn-pushable:hover .local-btn-front {
              transform: translateY(-6px);
              transition:
                transform
                250ms
                cubic-bezier(.3, .7, .4, 1.5);
            }
            .local-btn-pushable:active .local-btn-front {
              transform: translateY(-2px);
              transition: transform 34ms;
            }
            .local-btn-pushable:hover .local-btn-shadow {
              transform: translateY(4px);
              transition:
                transform
                250ms
                cubic-bezier(.3, .7, .4, 1.5);
            }
            .local-btn-pushable:active .local-btn-shadow {
              transform: translateY(1px);
              transition: transform 34ms;
            }
            .local-btn-pushable:focus:not(:focus-visible) {
              outline: none;
            }
            #top {
                display: none; /* Hidden by default */
                position: fixed; /* Fixed/sticky position */
                bottom: 20px; /* Place the button at the bottom of the page */
                right: 30px; /* Place the button 30px from the right */
                z-index: 99; /* Make sure it does not overlap */
                border: none; /* Remove borders */
                outline: none; /* Remove outline */
                background-color: red; /* Set a background color */
                color: white; /* Text color */
                cursor: pointer; /* Add a mouse pointer on hover */
                padding: 15px; /* Some padding */
                border-radius: 10px; /* Rounded corners */
                font-size: 18px; /* Increase font size */
            }
            #top:hover {
                background-color: #555;
            }
        </style>
    </head>
    <body>
        <div class="container-fluid text-center">
            <!-- title -->
            <div class="row">
                <div class="col">
                    <h1>{{.Title}}</h1>
                    {{.Description}}
                </div>
            </div>
            <!-- break -->
            <div class="row">
                <div class="col">
                    <hr>
                </div>
            </div>
            <!-- navigation buttons -->
            <div class="row">
                <div class="col-xl-2 col-lg-0">
                </div>
                <div class="col-xl-2 col-lg-3">
                    <button class="local-btn-pushable" onclick="window.open('/d/dashList/dashboard-list?from=now-7d&to=now&var-MaxIntervalSeconds=30&var-ProduceDelta&var-ClusterName=All&var-NodeIdent=All&var-Namespace=All&var-Histogram=NONE&var-HistogramDev=NONE&var-HistogramUs=NONE&var-HistogramCount=NONE&var-HistogramSize=NONE&var-XdrDcName=All&var-xdr5dc=All&var-warnC=All&var-warnCtx=All&var-errC=All&var-errCtx=All&orgId=1','_blank');">
                        <span class="local-btn-shadow"></span>
                        <span class="local-btn-edge"></span>
                        <span class="local-btn-front">
                            <i class="fa-solid fa-chart-line fa-5x"></i><br />Grafana
                        </span>
                    </button>
                </div>
                <div class="col-xl-2 col-lg-3">
                    <button class="local-btn-pushable" onclick="window.open('/agi/ttyd','_blank');">
                        <span class="local-btn-shadow"></span>
                        <span class="local-btn-edge"></span>
                        <span class="local-btn-front">
                            <i class="fa-solid fa-terminal fa-5x"></i><br />Terminal
                        </span>
                    </button>
                </div>
                <div class="col-xl-2 col-lg-3">
                    <button class="local-btn-pushable" onclick="window.open('/agi/filebrowser','_blank');">
                        <span class="local-btn-shadow"></span>
                        <span class="local-btn-edge"></span>
                        <span class="local-btn-front">
                            <i class="fa-solid fa-folder-open fa-5x"></i><br />File Browser
                        </span>
                    </button>
                </div>
                <div class="col-xl-2 col-lg-3">
                    <button class="local-btn-pushable" id="statusLoader">
                        <span class="local-btn-shadow"></span>
                        <span class="local-btn-edge"></span>
                        <span class="local-btn-front">
                            <i class="fa-solid fa-info fa-5x"></i><br />Status
                        </span>
                    </button>
                </div>
                <div class="col-xl-2 col-lg-0">
                </div>
            </div>
            <!-- break -->
            <div class="row">
                <div class="col">
                    <hr>
                </div>
            </div>
            <!-- details -->
            <div class="row" id="statusRow" style="display:none;">
                <div class="col">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="mainNav" data-bs-tabs="tabs"> <!-- class="nav nav-pills" -->
                                <li class="nav-item">
                                    <a class="nav-link navMemory" data-bs-toggle="tab" href="#status">Status</a>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Ingest</a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#filesdl" id="btndl">Downloader</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#filesun" id="btnun">Unpacker</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#filespp" id="btnpp">Pre-Processor</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#fileslp" id="btnlp">Log Processor</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#filescp" id="btncp">CF Processor</a></li>
                                    </ul>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link navMemory" data-bs-toggle="tab" href="#ingestwarns">Errors</a>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Instance</a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#logsasd">Aerospike Logs</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#logsproxy">Proxy Logs</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#logsingest">Ingest Logs</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#logsplugin">Plugin Logs</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#logsgfix">Grafanafix Logs</a></li>
                                        <li><a class="dropdown-item navMemory" data-bs-toggle="tab" href="#dmesg">Dmesg</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <form class="card-body tab-content">
                            <div class="tab-pane" id="status">
                                <p class="card-text" id="statusMsg"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <div class="tab-pane" id="filesdl" aria-labelledby="#filesdl">
                                <span class="card-text"><table id="tfilesdl" class="hover compact cell-border" style="width: 100%;"><thead><tr>
                                        <th>Source</th>
                                        <th>File</th>
                                        <th>Size</th>
                                        <th>Downloaded</th>
                                        <th>Error</th>
                                    </tr></thead><tbody></tbody><tfoot><tr>
                                        <th>Source</th>
                                        <th>File</th>
                                        <th>Size</th>
                                        <th>Downloaded</th>
                                        <th>Error</th>
                                </tr></tfoot></table></span>
                            </div>
                            <div class="tab-pane" id="filesun" aria-labelledby="#filesun">
                                <span class="card-text"><table id="tfilesun" class="hover compact cell-border" style="width: 100%;"><thead><tr>
                                        <th>File</th>
                                        <th>Size</th>
                                        <th>IsCollectInfo</th>
                                        <th>IsArchive</th>
                                        <th>IsText</th>
                                        <th>UnpackFailed</th>
                                        <th>Errors</th>
                                    </tr></thead><tbody></tbody><tfoot><tr>
                                        <th>File</th>
                                        <th>Size</th>
                                        <th>IsCollectInfo</th>
                                        <th>IsArchive</th>
                                        <th>IsText</th>
                                        <th>UnpackFailed</th>
                                        <th>Errors</th>
                                </tr></tfoot></table></span>
                            </div>
                            <div class="tab-pane" id="filespp" aria-labelledby="#filespp">
                                <span class="card-text"><table id="tfilespp" class="hover compact cell-border" style="width: 100%;"><thead><tr>
                                        <th>Input File</th>
                                        <th>Size</th>
                                        <th>IsCollectInfo</th>
                                        <th>IsArchive</th>
                                        <th>IsText</th>
                                        <th>Output Files</th>
                                        <th>IsDuplicate</th>
                                        <th>DuplicateOf</th>
                                        <th>Errors</th>
                                    </tr></thead><tbody></tbody><tfoot><tr>
                                        <th>Input File</th>
                                        <th>Size</th>
                                        <th>IsCollectInfo</th>
                                        <th>IsArchive</th>
                                        <th>IsText</th>
                                        <th>Output Files</th>
                                        <th>IsDuplicate</th>
                                        <th>DuplicateOf</th>
                                        <th>Errors</th>
                                </tr></tfoot></table></span>
                            </div>
                            <div class="tab-pane" id="fileslp" aria-labelledby="#fileslp">
                                <span class="card-text"><table id="tfileslp" class="hover compact cell-border" style="width: 100%;"><thead><tr>
                                        <th>File</th>
                                        <th>ClusterName</th>
                                        <th>NodeID</th>
                                        <th>TotalSize</th>
                                        <th>ProcessedSize</th>
                                        <th>CompletePct</th>
                                        <th>IsFinished</th>
                                        <th>LineErrors</th>
                                    </tr></thead><tbody></tbody><tfoot><tr>
                                        <th>File</th>
                                        <th>ClusterName</th>
                                        <th>NodeID</th>
                                        <th>TotalSize</th>
                                        <th>ProcessedSize</th>
                                        <th>CompletePct</th>
                                        <th>IsFinished</th>
                                        <th>LineErrors</th>
                                </tr></tfoot></table></span>
                            </div>
                            <div class="tab-pane" id="filescp" aria-labelledby="#filescp">
                                <span class="card-text"><table id="tfilescp" class="hover compact cell-border" style="width: 100%;"><thead><tr>
                                        <th>File</th>
                                        <th>Size</th>
                                        <th>NodeID</th>
                                        <th>Renamed</th>
                                        <th>OriginalName</th>
                                        <th>Processed</th>
                                        <th>Errors</th>
                                    </tr></thead><tbody></tbody><tfoot><tr>
                                        <th>File</th>
                                        <th>Size</th>
                                        <th>NodeID</th>
                                        <th>Renamed</th>
                                        <th>OriginalName</th>
                                        <th>Processed</th>
                                        <th>Errors</th>
                                </tr></tfoot></table></span>
                            </div>
                            <div class="tab-pane" id="ingestwarns">
                                <p class=" card-text"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <div class="tab-pane" id="logsasd">
                                <p class=" card-text" id="logsasdp"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <div class="tab-pane" id="logsproxy">
                                <p class=" card-text" id="logsproxyp"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <div class="tab-pane" id="logsingest">
                                <p class=" card-text" id="logsingestp"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <div class="tab-pane" id="logsplugin">
                                <p class=" card-text" id="logspluginp"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <div class="tab-pane" id="logsgfix">
                                <p class=" card-text" id="logsgfixp"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <div class="tab-pane" id="dmesg">
                                <p class=" card-text" id="dmesgp"><i class="fa-solid fa-spinner fa-spin"></i></p>
                            </div>
                            <!-- placeholder: non-tabbed content goes here -->
                        </form>
                   </div>
                </div>
            </div>
            <!-- break -->
            <div class="row">
                <div class="col">
                    <br />
                </div>
            </div>
        </div>
        <button onclick="topFunction()" id="top" title="Go to top">Top</button>
    </body>
    <script src="dist/bs/bootstrap.bundle.min.js"></script>
    <script src="dist/fa/fontawesome.min.js"></script>
    <script src="dist/datatables/jquery.min.js"></script>
    <script src="dist/datatables/jquery-ui.min.js"></script>
    <script src="dist/datatables/datatables.min.js"></script>
    <script>
        class Mutex {
            constructor() {
                this._locking = Promise.resolve();
                this._locked = false;
            }
        
            isLocked() {
                return this._locked;
            }
        
            lock() {
                this._locked = true;
                let unlockNext;
                let willLock = new Promise(resolve => unlockNext = resolve);
                willLock.then(() => this._locked = false);
                let willUnlock = this._locking.then(() => unlockNext);
                this._locking = this._locking.then(() => willLock);
                return willUnlock;
            }
        }
        $(function() {
            // kick off loading of data
            var detailLoader = new Mutex(); // need a mutex to ensure that the data gets loaded BEFORE the tables can be processed
            var loadedDetails = {}; // this is where loadFileDetails will load the details
            var loadedTables = []; // stores a list of initialized tables so we do not attempt to load the tables more than once
            var statusLoaded = false;
            $('#statusLoader').on('click',loadAllStatus);
            function loadAllStatus() {
                if (statusLoaded) {
                    alert("Status already loaded. To update, refresh the browser window.");
                    return;
                }
                statusLoaded = true;
                $('#statusLoader').hide();
                $("#statusRow").show();
                window.location.href="#showstatus";
                setTimeout(function() {
                    getStatus(); // this will happen in async
                    getAgiLogs(); // this can happen in async at the same time
                    async function loadFileDetailsAsync() {
                        var mutexunlock = await detailLoader.lock(); // lock a mutex indicating we will be loading the data - to stop datatables from loading until this completes
                        setTimeout(async function() {
                            loadFileDetails(mutexunlock); // start loading data in the background ... this allows the rest of the code to proceed while a huge load happens
                        },100);
                    };
                    loadFileDetailsAsync();
                    loadLastTab();
                },100);
            };
            if (window.location.hash == "#showstatus") {
                $('#statusLoader').click();
            };

            $('#btndl').on('click', function() {loadTable('#tfilesdl')});
            $('#btnun').on('click', function() {loadTable('#tfilesun')});
            $('#btnpp').on('click', function() {loadTable('#tfilespp')});
            $('#btnlp').on('click', function() {loadTable('#tfileslp')});
            $('#btncp').on('click', function() {loadTable('#tfilescp')});

            // datatable loader
            async function loadTable(id) {
                console.log("loading "+id+", obtaining lock");
                var mutexunlock = await detailLoader.lock();
                console.log("got lock, loading "+id);
                if (loadedDetails[id] == null || loadedDetails[id] == undefined) {
                    console.log(id+" has no data, unlock and exit");
                    mutexunlock();
                    return;
                };
                if (loadedTables.includes(id)) {
                    console.log(id+" already loaded");
                    mutexunlock();
                    return;
                };
                let fixedCols = 1;
                if (id == "#tfilesdl") {
                    filxedCols = 2;
                };
                $(id).DataTable({
                        data: loadedDetails[id],
                        fixedColumns: {left: fixedCols},
                });
                loadedTables.push(id);
                mutexunlock();
                console.log("loaded "+id+", lock released");
            }

            // on load, if activeTab is saved, go there
            function loadLastTab() {
                var activeTab = localStorage.getItem("activeTab");
                // if activeTab is unset, set first tab as active
                if (activeTab == null) {
                    $('.navMemory').each(function(i,elem) {
                        $(elem).addClass("active");
                        var id = $(elem).attr('href');
                        $(id).addClass("active");
                        return false;
                    });
                    return;
                }

                // set saved tab as active
                $(activeTab).addClass('active');
                // set the button for the tab as active
                $('.navMemory').each(function(i,elem) {
                    if ($(elem).attr('href') == activeTab) {
                        $(elem).addClass("active");
                        // handle dropdowns
                        if ($(elem).hasClass('dropdown-item')) {
                            $($(elem).parent('li').parent('ul').parent('li').children('a')[0]).addClass('active');
                        }
                        return false;
                    };
                })
                // if the active tab is one of those with a files table, also call to load the datatable
                if (activeTab.startsWith('#files')) {
                    loadTable(activeTab.replace(/#files/, '#tfiles'));
                }
            };

            // on click of nav item, store location
            $('.navMemory').click(function(obj) {
                localStorage.setItem("activeTab", $(obj.target).attr('href'));
            })

            // load status id=statusMsg innerHTML
            function getStatus() {
                $.getJSON("/agi/api/status?shorten=1000", function(data){ // shorten = max errors to return from server (plus line stating how many entries were truncated)
                    var asdStatus = "<font color=red>Aerospike NOT Running</font>";
                    if (data["AerospikeRunning"]) {
                        asdStatus = "<font color=green>Aerospike Running</font>";
                    }
                    var pluginStatus = "<font color=red>Grafana Plugin NOT Running</font>";
                    if (data["PluginRunning"]) {
                        pluginStatus = "<font color=green>Grafana Plugin Running</font>";
                    }
                    var gfixStatus = "<font color=red>Grafana Helper NOT Running</font>";
                    if (data["GrafanaHelperRunning"]) {
                        gfixStatus = "<font color=green>Grafana Helper Running</font>";
                    }
                    var ingestStatus = "<font color=orange>Ingest Running</font>";
                    if (!data["Ingest"]["Running"] && data["Ingest"]["CompleteSteps"]["Init"] && data["Ingest"]["CompleteSteps"]["Download"] && data["Ingest"]["CompleteSteps"]["Unpack"] && data["Ingest"]["CompleteSteps"]["PreProcess"] && data["Ingest"]["CompleteSteps"]["ProcessLogs"] && data["Ingest"]["CompleteSteps"]["ProcessCollectInfo"]) {
                        ingestStatus = "<font color=green>Ingest Finished</font>";
                    } else if (!data["Ingest"]["Running"]) {
                        ingestStatus = "<font color=red>Ingest FAILED ("+data["Ingest"]["CompleteSteps"]["CriticalError"]+")</font>";
                    };
                    var dlStatus = data["Ingest"]["DownloaderCompletePct"] + "% (" + formatBytes(data["Ingest"]["DownloaderCompleteSize"]) + " / " + formatBytes(data["Ingest"]["DownloaderTotalSize"]) + ")";
                    var lpStatus = data["Ingest"]["LogProcessorCompletePct"] + "% (" + formatBytes(data["Ingest"]["LogProcessorCompleteSize"]) + " / " + formatBytes(data["Ingest"]["LogProcessorTotalSize"]) + ")";
                    if (data["Ingest"]["CompleteSteps"]["DownloadStartTime"].startsWith("0001-01-01T00:00:00")) {
                        data["Ingest"]["CompleteSteps"]["DownloadStartTime"] = "";
                    }
                    if (data["Ingest"]["CompleteSteps"]["DownloadEndTime"].startsWith("0001-01-01T00:00:00")) {
                        data["Ingest"]["CompleteSteps"]["DownloadEndTime"] = "";
                    }
                    if (data["Ingest"]["CompleteSteps"]["ProcessLogsStartTime"].startsWith("0001-01-01T00:00:00")) {
                        data["Ingest"]["CompleteSteps"]["ProcessLogsStartTime"] = "";
                    }
                    if (data["Ingest"]["CompleteSteps"]["ProcessLogsEndTime"].startsWith("0001-01-01T00:00:00")) {
                        data["Ingest"]["CompleteSteps"]["ProcessLogsEndTime"] = "";
                    }
                    if ((data["Ingest"]["DownloaderCompletePct"] < 100 || data["Ingest"]["DownloaderCompleteSize"] < data["Ingest"]["DownloaderTotalSize"]) && data["Ingest"]["CompleteSteps"]["DownloadStartTime"] != "") {
                        let now = new Date();
                        let elapsed = Math.round((now - Date.parse(data["Ingest"]["CompleteSteps"]["DownloadStartTime"]))/1000);
                        let bytesPerSec = 0;
                        if (elapsed > 0) {
                            bytesPerSec = Math.round(data["Ingest"]["DownloaderCompleteSize"] / elapsed);
                        };
                        let remainBytes = data["Ingest"]["DownloaderTotalSize"] - data["Ingest"]["DownloaderCompleteSize"];
                        let remain = 0;
                        if (bytesPerSec > 0) {
                            remain = Math.round(remainBytes/bytesPerSec);
                        }
                        let endTime = new Date();
                        endTime = new Date(endTime.getTime() + (remain*1000));
                        let totalTime = elapsed + remain;
                        dlStatus = dlStatus + " (speed:"+formatBytes(bytesPerSec)+") (elapsed:"+formatDuration(elapsed)+" remaining:"+formatDuration(remain)+" total:"+formatDuration(totalTime)+") End Time Estimate:"+endTime.toString();
                    }
                    if ((data["Ingest"]["LogProcessorCompletePct"] < 100 || data["Ingest"]["LogProcessorCompleteSize"] < data["Ingest"]["LogProcessorTotalSize"]) && data["Ingest"]["CompleteSteps"]["ProcessLogsStartTime"] != "") {
                        let now = new Date();
                        let elapsed = Math.round((now - Date.parse(data["Ingest"]["CompleteSteps"]["ProcessLogsStartTime"]))/1000);
                        let bytesPerSec = 0;
                        if (elapsed > 0) {
                            bytesPerSec = Math.round(data["Ingest"]["LogProcessorCompleteSize"] / elapsed);
                        };
                        let remainBytes = data["Ingest"]["LogProcessorTotalSize"] - data["Ingest"]["LogProcessorCompleteSize"];
                        let remain = 0;
                        if (bytesPerSec > 0) {
                            remain = Math.round(remainBytes/bytesPerSec);
                        }
                        let endTime = new Date();
                        endTime = new Date(endTime.getTime() + (remain*1000));
                        let totalTime = elapsed + remain;
                        lpStatus = lpStatus + " (speed:"+formatBytes(bytesPerSec)+") (elapsed:"+formatDuration(elapsed)+" remaining:"+formatDuration(remain)+" total:"+formatDuration(totalTime)+") End Time Estimate:"+endTime.toString();
                    }
                    var errorStr = "<font color=green>No Errors</font>";
                    if (data["Ingest"]["Errors"] != null) {
                        for (let i = 0; i < data["Ingest"]["Errors"].length;i++) {
                            errorStr = "<font color=red>Errors: "+data["Ingest"]["Errors"].length+"</font>";
                        }
                    }
                    $('#statusMsg').html($(document.createElement('div'))
                        .css("text-align","left")
                        .append($(document.createElement('ul'))
                            .append($(document.createElement('li')).html(asdStatus))
                            .append($(document.createElement('li')).html(pluginStatus))
                            .append($(document.createElement('li')).html(gfixStatus))
                            .append($(document.createElement('li')).html(ingestStatus))
                            .append($(document.createElement('li')).html("System")
                                .append($(document.createElement('ul'))
                                    .append($(document.createElement('li')).html("Memory Free: " + formatBytes(data["System"]["MemoryFreeBytes"])))
                                    .append($(document.createElement('li')).html("Memory Total: " + formatBytes(data["System"]["MemoryTotalBytes"])))
                                    .append($(document.createElement('li')).html("Disk Free: " + formatBytes(data["System"]["DiskFreeBytes"])))
                                    .append($(document.createElement('li')).html("Disk Total: " + formatBytes(data["System"]["DiskTotalBytes"])))
                                )
                            )
                            .append($(document.createElement('li')).html("Ingest")
                                .append($(document.createElement('ul'))
                                    .append($(document.createElement('li')).html("Running: "+data["Ingest"]["Running"]))
                                    .append($(document.createElement('li')).html("Downloaded: " + dlStatus))
                                    .append($(document.createElement('li')).html("Processed: " + lpStatus))
                                    .append($(document.createElement('li')).html("Complete Steps")
                                        .append($(document.createElement('ul'))
                                            .append($(document.createElement('li')).html(prettyComplete(data["Ingest"]["CompleteSteps"]["Init"], "Init")))
                                            .append($(document.createElement('li')).html(prettyComplete(data["Ingest"]["CompleteSteps"]["Download"], "Download")))
                                            .append($(document.createElement('li')).html(prettyComplete(data["Ingest"]["CompleteSteps"]["Unpack"], "Unpack")))
                                            .append($(document.createElement('li')).html(prettyComplete(data["Ingest"]["CompleteSteps"]["PreProcess"], "PreProcess")))
                                            .append($(document.createElement('li')).html(prettyComplete(data["Ingest"]["CompleteSteps"]["ProcessLogs"], "ProcessLogs")))
                                            .append($(document.createElement('li')).html(prettyComplete(data["Ingest"]["CompleteSteps"]["ProcessCollectInfo"], "ProcessCollectInfo")))
                                        )
                                    )
                                    .append($(document.createElement('li')).html("Times")
                                        .append($(document.createElement('ul'))
                                            .append($(document.createElement('li')).html("Download Start Time: "+data["Ingest"]["CompleteSteps"]["DownloadStartTime"]))
                                            .append($(document.createElement('li')).html("Download End Time: "+data["Ingest"]["CompleteSteps"]["DownloadEndTime"]))
                                            .append($(document.createElement('li')).html("Processor Start Time: "+data["Ingest"]["CompleteSteps"]["ProcessLogsStartTime"]))
                                            .append($(document.createElement('li')).html("Processor End Time: "+data["Ingest"]["CompleteSteps"]["ProcessLogsEndTime"]))
                                        )
                                    )
                                    .append($(document.createElement('li')).html(errorStr))
                                )
                            )
                        )
                    );
                    showLogErrors(data["Ingest"]["Errors"]);
                })
                .fail(function(data) {
                    let body = data.responseText;
                    if ((data.status == 0)&&(body == undefined)) {
                        body = "Connection Error";
                    }
                    body = data.statusText+": "+body;
                    $("#statusMsg").css("text-align","left").text("ERROR: "+body);
                });
            };
            function prettyComplete(data, name) {
                if (data) {
                    return "<font color=green>"+name+": "+data+"</font>";
                } else {
                    return "<font color=orange>"+name+": "+data+"</font>";
                };
            };

            // datatables defaults
            Object.assign(DataTable.defaults, {
                paging: false,
                //scrollCollapse: true,
                //scrollY: '70vh',
                scrollX: true,
                stateSave: true,
                fixedHeader: true,
                //select: true,
                dom: 'Bfrtip',
                buttons: [{extend: "colvis", text:"Columns"}],
            });

            // /agi/ingest/detail?detail=FILE.json' ;; {"downloader.json", "unpacker.json", "pre-processor.json", "log-processor.json", "cf-processor.json"}
            async function loadFileDetails(mutexunlock) {
                // downloader
                $.ajax({
                    async: false,
                    type: 'GET',
                    dataType: "json",
                    url: '/agi/ingest/detail?detail=downloader.json',
                    success: function(data) {
                        let out = [];
                        for (var source of ["S3","Sftp"]) {
                            let src=source+"Files";
                            for (var fn in data[src]) {
                                out.push([source,fn,formatBytes(data[src][fn]["Size"]),data[src][fn]["IsDownloaded"],data[src][fn]["Error"]]);
                            };
                        };
                        $("#filesdl").css("text-align","left");
                        loadedDetails["#tfilesdl"] = out;
                    },
                    error: function(data) {
                        let body = data.responseText;
                        if ((data.status == 0)&&(body == undefined)) {
                            body = "Connection Error";
                        }
                        body = data.statusText+": "+body;
                        $("#filesdl").css("text-align","left").text("ERROR: "+body);
                    }
                });

                // unpacker
                $.ajax({
                    async: false,
                    type: 'GET',
                    dataType: "json",
                    url: '/agi/ingest/detail?detail=unpacker.json',
                    success: function(data) {
                        let out = [];
                        for (var fn in data["Files"]) {
                            var errStr = "";
                            if (data["Files"][fn]["Errors"] != null && data["Files"][fn]["Errors"].length > 0) {
                                errStr = data["Files"][fn]["Errors"].join("<br>");
                            }
                            out.push([
                                fn,
                                formatBytes(data["Files"][fn]["Size"]),
                                data["Files"][fn]["IsCollectInfo"],
                                data["Files"][fn]["IsArchive"],
                                data["Files"][fn]["IsText"],
                                data["Files"][fn]["UnpackFailed"],
                                errStr,
                            ]);
                        };
                        $("#filesun").css("text-align","left");
                        loadedDetails["#tfilesun"] = out;
                    },
                    error: function(data) {
                        let body = data.responseText;
                        if ((data.status == 0)&&(body == undefined)) {
                            body = "Connection Error";
                        }
                        body = data.statusText+": "+body;
                        $("#filesun").css("text-align","left").text("ERROR: "+body);
                    }
                });

                // pre-processor
                $.ajax({
                    async: false,
                    type: 'GET',
                    dataType: "json",
                    url: '/agi/ingest/detail?detail=pre-processor.json',
                    success: function(data) {
                        let out = [];
                        for (var fn in data["Files"]) {
                            var errStr = "";
                            if (data["Files"][fn]["Errors"] != null && data["Files"][fn]["Errors"].length > 0) {
                                errStr = data["Files"][fn]["Errors"].join("<br>");
                            }
                            var isDup = false;
                            var dupStr = "";
                            var outStr = "";
                            if (data["Files"][fn]["PreProcessDuplicateOf"] != null && data["Files"][fn]["PreProcessDuplicateOf"].length > 0) {
                                isDup = true;
                                dupStr = data["Files"][fn]["PreProcessDuplicateOf"].join("<br>");
                            }
                            if (data["Files"][fn]["PreProcessOutPaths"] != null && data["Files"][fn]["PreProcessOutPaths"].length > 0) {
                                outStr = data["Files"][fn]["PreProcessOutPaths"].join("<br>");
                            }
                            out.push([
                                fn,
                                formatBytes(data["Files"][fn]["Size"]),
                                data["Files"][fn]["IsCollectInfo"],
                                data["Files"][fn]["IsArchive"],
                                data["Files"][fn]["IsText"],
                                outStr,
                                isDup,
                                dupStr,
                                errStr,
                            ]);
                        };
                        $("#filespp").css("text-align","left");
                        loadedDetails["#tfilespp"] = out;
                    },
                error:function(data) {
                        let body = data.responseText;
                        if ((data.status == 0)&&(body == undefined)) {
                            body = "Connection Error";
                        }
                        body = data.statusText+": "+body;
                        $("#filespp").css("text-align","left").text("ERROR: "+body);
                    }
                });

                // log-processor
                $.ajax({
                    async: false,
                    type: 'GET',
                    dataType: "json",
                    url: '/agi/ingest/detail?detail=log-processor.json',
                    success: function(data) {
                        let out = [];
                        for (var fn in data["Files"]) {
                            var errStr = [];
                            nodeIdent = data["Files"][fn]["NodePrefix"];
                            if (data["LineErrors"] != null && data["LineErrors"][nodeIdent] != null) {
                                for (var errName in data["LineErrors"][nodeIdent]) {
                                    errStr.push("(repeated:"+data["LineErrors"][nodeIdent][errName]+") " + errName);
                                }
                            }
                            var pct = Math.floor((data["Files"][fn]["Processed"] / data["Files"][fn]["Size"])*100);
                            out.push([
                                fn,
                                data["Files"][fn]["ClusterName"],
                                data["Files"][fn]["NodeID"],
                                formatBytes(data["Files"][fn]["Size"]),
                                formatBytes(data["Files"][fn]["Processed"]),
                                pct,
                                data["Files"][fn]["Finished"],
                                errStr.join("<br>"),
                            ]);
                        };
                        $("#fileslp").css("text-align","left");
                        loadedDetails["#tfileslp"] = out;
                    },
                error: function(data) {
                        let body = data.responseText;
                        if ((data.status == 0)&&(body == undefined)) {
                            body = "Connection Error";
                        }
                        body = data.statusText+": "+body;
                        $("#fileslp").css("text-align","left").text("ERROR: "+body);
                    }
                });

                // cf-processor
                $.ajax({
                    async: false,
                    type: 'GET',
                    dataType: "json",
                    url: '/agi/ingest/detail?detail=cf-processor.json',
                    success: function(data) {
                        let out = [];
                        for (var fn in data["Files"]) {
                            var errStr = "";
                            if (data["Files"][fn]["Errors"] != null && data["Files"][fn]["Errors"].length > 0) {
                                errStr = data["Files"][fn]["Errors"].join("<br>");
                            }
                            out.push([
                                fn,
                                formatBytes(data["Files"][fn]["Size"]),
                                data["Files"][fn]["NodeID"],
                                data["Files"][fn]["Renamed"],
                                data["Files"][fn]["OriginalName"],
                                data["Files"][fn]["Processed"],
                                errStr,
                            ]);
                        };
                        $("#filescp").css("text-align","left");
                        loadedDetails["#tfilescp"] = out;
                    },
                error: function(data) {
                        let body = data.responseText;
                        if ((data.status == 0)&&(body == undefined)) {
                            body = "Connection Error";
                        }
                        body = data.statusText+": "+body;
                        $("#filescp").css("text-align","left").text("ERROR: "+body);
                    }
                });
                mutexunlock();
            }

            // log errors - gets kicked off by status loaded which receives the errors in a list
            function showLogErrors(errArr = []) {
                /* example format
                var logErrors = {
                    "Downloader": [
                        "error line 1",
                        "error line 2",
                        {
                            "file": "bob.log",
                            "error": "error line 3",
                        },
                    ],
                    "Unpacker": [...],
                    ...
                };
                */
                var logErrors = {};
                if (errArr != null && errArr.length > 0) {
                    for (var i = 0; i<errArr.length; i++) {
                        let item = errArr[i].split('::');
                        let nerr = item[3];
                        if (item[2] > 1) {
                            item[2]--;
                            nerr = '(repeated:'+item[2]+') '+nerr;
                        }
                        if (logErrors[item[0]] == undefined || logErrors[item[0]] == null) {
                            logErrors[item[0]] = [];
                        }
                        logErrors[item[0]].push({
                            "file": item[1],
                            "error": nerr,
                        })
                    }
                }

                if (Object.keys(logErrors).length == 0) {
                    $('#ingestwarns').html($(document.createElement('div')).css("text-align","left").html("<font color=green>None</font>"));
                    return
                }
                var hasErrors = false;
                for (var key in logErrors){
                    if (logErrors[key].length > 0) {
                        hasErrors = true;
                        break;
                    }
                }
                if (!hasErrors) {
                    $('#ingestwarns').html($(document.createElement('div')).css("text-align","left").html("<font color=green>None</font>"));
                    return
                }
                var mainUl = $(document.createElement('ul'));
                for (var key in logErrors){
                    var values = logErrors[key];
                    if (values == null || values.length == 0) {
                        continue;
                    };
                    var vals = $(document.createElement('ul'));
                    for (let i = 0; i < values.length; i++) {
                        if (typeof values[i] != "object") {
                            vals.append($(document.createElement('li'))
                                .append($(document.createElement('code'))
                                    .attr('color','red')
                                    .text(values[i])
                                )
                            )
                        } else {
                            vals.append($(document.createElement('li'))
                                .append('['+values[i]["file"]+'] ')
                                .append($(document.createElement('code'))
                                    .attr('color','red')
                                    .text(values[i]["error"])
                                )
                            )
                        }
                    };
                    mainUl.append($(document.createElement('li'))
                    .append($(document.createElement('span'))
                        .css('font-weight','bold')
                        .html(key)
                    ).append(vals));
                };
                $('#ingestwarns').html($(document.createElement('div')).css("text-align","left").append(mainUl));
            };

            // AGI logs - up to last 20KiB or 200 lines per log
            function getAgiLogs() {
                $.getJSON("/agi/api/logs", function(data){
                    $("#logsasdp").css("text-align","left").html($(document.createElement('pre')).html($(document.createElement('code')).text(data["AerospikeLogs"])));
                    $("#logsproxyp").css("text-align","left").html($(document.createElement('pre')).html($(document.createElement('code')).text(data["ProxyLogs"])));
                    $("#logsingestp").css("text-align","left").html($(document.createElement('pre')).html($(document.createElement('code')).text(data["IngestLogs"])));
                    $("#logspluginp").css("text-align","left").html($(document.createElement('pre')).html($(document.createElement('code')).text(data["PluginLogs"])));
                    $("#logsgfixp").css("text-align","left").html($(document.createElement('pre')).html($(document.createElement('code')).text(data["GrafanaFixLogs"])));
                    $("#dmesgp").css("text-align","left").html($(document.createElement('pre')).html($(document.createElement('code')).text(data["Dmesg"])));
                })
                .fail(function(data) {
                    let body = data.responseText;
                    if ((data.status == 0)&&(body == undefined)) {
                        body = "Connection Error";
                    }
                    body = data.statusText+": "+body;
                    $("#logsasdp").css("text-align","left").text("ERROR: "+body);
                    $("#logsproxyp").css("text-align","left").text("ERROR: "+body);
                    $("#logsingestp").css("text-align","left").text("ERROR: "+body);
                    $("#logspluginp").css("text-align","left").text("ERROR: "+body);
                    $("#logsgfixp").css("text-align","left").text("ERROR: "+body);
                    $("#dmesgp").css("text-align","left").text("ERROR: "+body);
                });
            };

            // helper - convert size
            function formatBytes(bytes, decimals = 2) {
                if (!+bytes) return '0 Bytes'
                const k = 1024
                const dm = decimals < 0 ? 0 : decimals
                const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB']
                const i = Math.floor(Math.log(bytes) / Math.log(k))
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`
            }
            function formatDuration(seconds) {
                if (seconds == 0) {
                    return '0';
                };
                let minutes = Math.floor(seconds / 60);
                seconds = seconds % 60;
                let hours = Math.floor(minutes / 60);
                minutes = minutes % 60;
                let days = Math.floor(hours/24);
                hours = hours % 24;
                if (days > 0) {
                    return days+"d"+hours+"h"+minutes+"m"+seconds+"s";
                }
                if (hours > 0) {
                    return hours+"h"+minutes+"m"+seconds+"s";
                }
                if (minutes > 0) {
                    return minutes+"m"+seconds+"s";
                }
                return seconds+"s";
            }
        });

        // back to top button
        window.onscroll = function() {scrollFunction()};
        function scrollFunction() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                document.getElementById("top").style.display = "block";
            } else {
                document.getElementById("top").style.display = "none";
            }
        }
        function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        };
    </script>
</html>
{{end}}
